#!/usr/bin/env sh

set -eo pipefail

source /usr/local/lib/log.sh
SECRETS_PATH="/opt/app/data/secrets"

if [ -z "${GITEA_SECURITY_INTERNAL_TOKEN}" ]; then
  if [ -f ${SECRETS_PATH}/internal ]; then
    export GITEA_SECURITY_INTERNAL_TOKEN=$(cat ${SECRETS_PATH}/internal | head -n1)
  else
    log_info "Generating internal token"
    export GITEA_SECURITY_INTERNAL_TOKEN=$(gitea generate secret INTERNAL_TOKEN)
    echo "${GITEA_SECURITY_INTERNAL_TOKEN}" >| ${SECRETS_PATH}/internal
  fi
fi

if [ -z "${GITEA_SECURITY_SECRET_KEY}" ]; then
  if [ -f ${SECRETS_PATH}/secret ]; then
    export GITEA_SECURITY_SECRET_KEY=$(cat ${SECRETS_PATH}/secret | head -n1)
  else
    log_info "Generating secret key"
    export GITEA_SECURITY_SECRET_KEY=$(gitea generate secret SECRET_KEY)
    echo "${GITEA_SECURITY_SECRET_KEY}" >| ${SECRETS_PATH}/secret
  fi
fi

if [ "${GITEA_SERVER_LFS_START_SERVER}" == "true" -a -z "${GITEA_SERVER_LFS_JWT_SECRET}" ]; then
  if [ -f ${SECRETS_PATH}/lfs ]; then
    export GITEA_SERVER_LFS_JWT_SECRET=$(cat ${SECRETS_PATH}/lfs | head -n1)
  else
    log_info "Generating lfs JWT"
    export GITEA_SERVER_LFS_JWT_SECRET=$(gitea generate secret LFS_JWT_SECRET)
    echo "${GITEA_SERVER_LFS_JWT_SECRET}" >| ${SECRETS_PATH}/lfs
  fi
fi

if [ "${GITEA_OAUTH2_ENABLED}" == "true" -a -z "${GITEA_OAUTH2_JWT_SECRET}" ]; then
  if [ -f ${SECRETS_PATH}/oauth2 ]; then
    export GITEA_OAUTH2_JWT_SECRET=$(cat ${SECRETS_PATH}/oauth2 | head -n1)
  else
    log_info "Generating OAuth2 JWT"
    export GITEA_OAUTH2_JWT_SECRET=$(gitea generate secret LFS_JWT_SECRET)
    echo "${GITEA_OAUTH2_JWT_SECRET}" >| ${SECRETS_PATH}/oauth2
  fi
fi

/usr/local/bin/gomplate -o /opt/app/config/app.ini -f /etc/templates/app.ini.tmpl
chmod 0600 /opt/app/config/app.ini

unset GITEA_SECURITY_INTERNAL_TOKEN GITEA_SECURITY_SECRET_KEY GITEA_SERVER_LFS_JWT_SECRET GITEA_OAUTH2_JWT_SECRET

log_info "Start Gitea\n"
exec /usr/bin/gitea web -c /opt/app/config/app.ini
